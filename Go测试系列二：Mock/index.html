<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-smile.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-smile.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="上一篇文章将带大家入门Golang单元测试，接下来，就是怎么Mock。Mock也就是‘模拟’，也就是模拟一些上下文环境，来制造你想要的某个特定条件，来看看你的待测逻辑，是否在此特定条件下，正确运行了你认为的逻辑。">
<meta name="keywords" content="Go,单元测试">
<meta property="og:type" content="article">
<meta property="og:title" content="Go测试系列二：Mock实践">
<meta property="og:url" content="http:&#x2F;&#x2F;jpuneng.cn&#x2F;Go%E6%B5%8B%E8%AF%95%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AMock&#x2F;index.html">
<meta property="og:site_name" content="jpuneng技术栈">
<meta property="og:description" content="上一篇文章将带大家入门Golang单元测试，接下来，就是怎么Mock。Mock也就是‘模拟’，也就是模拟一些上下文环境，来制造你想要的某个特定条件，来看看你的待测逻辑，是否在此特定条件下，正确运行了你认为的逻辑。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;jpuneng.cn&#x2F;images&#x2F;20210323&#x2F;2.png">
<meta property="og:image" content="http:&#x2F;&#x2F;jpuneng.cn&#x2F;images&#x2F;20210323&#x2F;3.png">
<meta property="og:image" content="http:&#x2F;&#x2F;jpuneng.cn&#x2F;images&#x2F;20210323&#x2F;4.png">
<meta property="og:updated_time" content="2021-03-23T06:54:04.635Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;jpuneng.cn&#x2F;images&#x2F;20210323&#x2F;2.png">

<link rel="canonical" href="http://jpuneng.cn/Go%E6%B5%8B%E8%AF%95%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AMock/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Go测试系列二：Mock实践 | jpuneng技术栈</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">jpuneng技术栈</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">技术时代，舍我其谁</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://jpuneng.cn/Go%E6%B5%8B%E8%AF%95%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AMock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jasper Wu">
      <meta itemprop="description" content="醒目点、自觉点、速度点，努力奋斗下去，走好自己的路！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jpuneng技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Go测试系列二：Mock实践
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-23 15:02:41 / 修改时间：14:54:04" itemprop="dateCreated datePublished" datetime="2021-03-23T15:02:41+08:00">2021-03-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go/" itemprop="url" rel="index">
                    <span itemprop="name">Go</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>上一篇文章将带大家入门Golang单元测试，接下来，就是怎么Mock。<code>Mock</code>也就是‘模拟’，也就是模拟一些上下文环境，来制造你想要的某个特定条件，来看看你的待测逻辑，是否在此特定条件下，正确运行了你认为的逻辑。</p>
</blockquote>
<a id="more"></a>

<p>以下就不说太多Golang和Java等其他语言的Mock测试环境的对比等等，我们直接上干货（附上Demo，每个分支都有对应的Mock案例）。</p>
<p>Demo Github 地址：<a href="https://github.com/androidjp/go-mock-best-practice" target="_blank" rel="noopener">https://github.com/androidjp/go-mock-best-practice</a></p>
<h1 id="gomock-mockgen"><a href="#gomock-mockgen" class="headerlink" title="gomock + mockgen"></a>gomock + mockgen</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul>
<li>接口打桩。对某个可赋值的依赖成员对象进行mock（比如 <code>ServiceA</code> 依赖 <code>RepositoryA</code>，那么，在测试 <code>ServiceA.MethodA</code>方法时，可以mock了<code>RepositoryA</code>）</li>
</ul>
<h2 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h2><ol>
<li><p>拉取安装gomock 和 mockgen</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -v -u github.com/golang/mock/gomock</span><br></pre></td></tr></table></figure>
<p> 得到 $GOPATH/src/github.com/golang/mock 目录下，有GoMock包和mockgen工具 两个子目录。<br> 第2，3，4步看你的$GOPATH/bin目录有没有已经安装好的mockgen可执行文件，有则可忽略后续步骤。</p>
</li>
<li><p>进入mockgen子目录，执行build命令，即生成了可执行程序mockgen；</p>
</li>
<li><p>将mockgen拷贝到$GOPATH/bin目录下；</p>
</li>
<li><p>指定环境变量Path包含$GOPATH/bin目录；</p>
</li>
<li><p>最后，尝试敲一下命令行：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mockgen help</span><br></pre></td></tr></table></figure>
<p> 如果出现<code>-bash: mockgen: command not found</code>，表示你的环境变量PATH中没有配置<code>$GOPATH/bin</code>。</p>
</li>
</ol>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go doc github.com/golang/mock/gomock</span><br></pre></td></tr></table></figure>

<p><a href="https://link.jianshu.com/?t=http://godoc.org/github.com/golang/mock/gomock" target="_blank" rel="noopener">在线参考文档</a></p>
<h2 id="mockgen使用"><a href="#mockgen使用" class="headerlink" title="mockgen使用"></a>mockgen使用</h2><ol>
<li><p>在项目根目录打开命令行</p>
</li>
<li><p>找到对应目录下的某个将你要mock的接口所在的.go文件，生成对应的mock文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mockgen -source=1_gomock/db/repository.go  &gt; test/1_gomock/db/mock_repository.go</span><br></pre></td></tr></table></figure>
<p> 当然，前提是你这个 <code>test/1_gomock/db/</code>目录已经存在。</p>
</li>
<li><p>然后，使用这个mock文件中的 <code>MockXxx(t)</code> 方法</p>
</li>
</ol>
<h2 id="关键用法"><a href="#关键用法" class="headerlink" title="关键用法"></a>关键用法</h2><h3 id="1-接口打桩步骤"><a href="#1-接口打桩步骤" class="headerlink" title="1. 接口打桩步骤"></a>1. 接口打桩步骤</h3><ol>
<li><p>首先，使用mockgen工具，将对应的接口生成mock文件</p>
</li>
<li><p>然后，开始打桩</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 初始化 mock控制器</span></span><br><span class="line">ctrl := gomock.NewController(t)</span><br><span class="line"><span class="keyword">defer</span> ctrl.Finish()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 初始化mock对象，并注入控制器</span></span><br><span class="line">mockRepo := mock_gomock_db.NewMockRepository(ctrl)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 设定mock对象的返回值</span></span><br><span class="line">mockRepo.EXPECT().Create(<span class="string">"name"</span>, []<span class="keyword">byte</span>(<span class="string">"jasper"</span>)).Return(<span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，测你要测的逻辑</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when</span></span><br><span class="line">demoSvr := &amp;gomock_service.DemoService&#123;Repo: mockRepo&#125;</span><br><span class="line">data, err := demoSvr.InsertData(<span class="string">"name"</span>, <span class="string">"jasper"</span>)</span><br><span class="line"><span class="comment">// then</span></span><br><span class="line">assert.Equal(t, <span class="string">"success"</span>, data)</span><br><span class="line">assert.Nil(t, err)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="2-接口打桩定义前N次返回值"><a href="#2-接口打桩定义前N次返回值" class="headerlink" title="2. 接口打桩定义前N次返回值"></a>2. 接口打桩定义前N次返回值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前两次返回错误</span></span><br><span class="line">mockRepo.EXPECT().Create(<span class="string">"name"</span>, []<span class="keyword">byte</span>(<span class="string">"jasper"</span>)).Return(errors.New(<span class="string">"db connection error"</span>)).Times(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 第三次正常</span></span><br><span class="line">mockRepo.EXPECT().Create(<span class="string">"name"</span>, []<span class="keyword">byte</span>(<span class="string">"jasper"</span>)).Return(<span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-断言接口调用顺序"><a href="#3-断言接口调用顺序" class="headerlink" title="3. 断言接口调用顺序"></a>3. 断言接口调用顺序</h3><p>方式一：<code>After</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// retrieve 先执行</span></span><br><span class="line">retrieveName := mockRepo.EXPECT().Retrieve(<span class="string">"name"</span>).Return([]<span class="keyword">byte</span>(<span class="string">"jasper"</span>), <span class="literal">nil</span>)</span><br><span class="line"><span class="comment">// update 在 retrieve 之后</span></span><br><span class="line">mockRepo.EXPECT().Update(<span class="string">"name"</span>, []<span class="keyword">byte</span>(<span class="string">"mike"</span>)).Return(<span class="literal">nil</span>).After(retrieveName)</span><br></pre></td></tr></table></figure>

<p>方式二：<code>InOrder</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gomock.InOrder(</span><br><span class="line">    <span class="comment">// retrieve 先执行</span></span><br><span class="line">    mockRepo.EXPECT().Retrieve(<span class="string">"name"</span>).Return([]<span class="keyword">byte</span>(<span class="string">"jasper"</span>), <span class="literal">nil</span>),</span><br><span class="line">    <span class="comment">// update 在 retrieve 之后</span></span><br><span class="line">    mockRepo.EXPECT().Update(<span class="string">"name"</span>, []<span class="keyword">byte</span>(<span class="string">"mike"</span>)).Return(<span class="literal">nil</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Demo示例"><a href="#Demo示例" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/1_gomock_1_basic" target="_blank" rel="noopener">https://github.com/androidjp/go-mock-best-practice/tree/1_gomock_1_basic</a></p>
<h1 id="gostub打桩"><a href="#gostub打桩" class="headerlink" title="gostub打桩"></a>gostub打桩</h1><h2 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h2><ul>
<li><p>全局变量打桩</p>
</li>
<li><p>函数打桩</p>
</li>
<li><p>过程打桩</p>
</li>
<li><p>第三方库打桩</p>
</li>
</ul>
<h2 id="安装与配置-1"><a href="#安装与配置-1" class="headerlink" title="安装与配置"></a>安装与配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -v -u github.com/prashantv/gostub</span><br></pre></td></tr></table></figure>

<h2 id="关键用法-1"><a href="#关键用法-1" class="headerlink" title="关键用法"></a>关键用法</h2><h3 id="1-全局变量打桩"><a href="#1-全局变量打桩" class="headerlink" title="1. 全局变量打桩"></a>1. 全局变量打桩</h3><p>对于全局变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  GlobalCount <span class="keyword">int</span></span><br><span class="line">  Host        <span class="keyword">string</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>可以这样打桩：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局变量 GlobalCount int 打桩</span></span><br><span class="line"><span class="comment">// 全局变量 Host string 打桩</span></span><br><span class="line">stubs := gostub.Stub(&amp;GlobalCount, <span class="number">10</span>).</span><br><span class="line">  Stub(&amp;Host, <span class="string">"https://www.bing.cn"</span>)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br></pre></td></tr></table></figure>

<h3 id="2-函数打桩"><a href="#2-函数打桩" class="headerlink" title="2. 函数打桩"></a>2. 函数打桩</h3><p>假设有个函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Exec</span><span class="params">(cmd <span class="keyword">string</span>, args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，首先我要先变成这样的写法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Exec = <span class="function"><span class="keyword">func</span><span class="params">(cmd <span class="keyword">string</span>, args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上写法不影响业务逻辑使用。</p>
<p>然后再进行打桩：</p>
<p>方式一：<code>StubFunc</code> 直接设置返回结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stubs := gostub.StubFunc(&amp;gomock_service.Exec, <span class="string">"xxx-vethName100-yyy"</span>, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br></pre></td></tr></table></figure>

<p>方式二：<code>Stub</code> 还能设置具体逻辑</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stubs := gostub.Stub(&amp;Exec, <span class="function"><span class="keyword">func</span><span class="params">(cmd <span class="keyword">string</span>, args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"xxx-vethName100-yyy"</span>, <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br></pre></td></tr></table></figure>

<h3 id="3-过程打桩"><a href="#3-过程打桩" class="headerlink" title="3. 过程打桩"></a>3. 过程打桩</h3><p>对于一些没有返回值的函数，我们称为“过程”：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> DestroyResource = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">"清理资源等工作"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打桩开始：</p>
<p>方式一：<code>StubFunc</code> 直接设置返回结果（当你想这个过程啥都不做时，可以这样）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stubs := gostub.StubFunc(&amp;gomock_service.DestroyResource)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br></pre></td></tr></table></figure>

<p>方式二：<code>Stub</code> 还能设置具体逻辑</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stubs := gostub.Stub(&amp;gomock_service.DestroyResource, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="comment">// do sth</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br></pre></td></tr></table></figure>

<h3 id="4-第三方库打桩"><a href="#4-第三方库打桩" class="headerlink" title="4. 第三方库打桩"></a>4. 第三方库打桩</h3><p>很多第三方库的函数（注意，是函数，不是某个对象的某个成员方法），我们会经常使用，而在单元测试时不是我们的关注点，或者想他报错等，就可以选择打桩。</p>
<ol>
<li><p>假如，我想打桩json的序列化和反序列化函数，那么，先在<code>adapter</code>包下定义<code>json.go</code>文件，然后声明对象：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> adapter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"encoding/json"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Marshal = json.Marshal</span><br><span class="line"><span class="keyword">var</span> UnMarshal = json.Unmarshal</span><br></pre></td></tr></table></figure>
</li>
<li><p>单元测试中，就可以直接使用<code>gostub.StubFunc</code>来进行打桩了：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// given</span></span><br><span class="line"><span class="keyword">var</span> mikeStr = <span class="string">`&#123;"name":"Jasper", "age":18&#125;`</span></span><br><span class="line">stubs := gostub.StubFunc(&amp;adapter.Marshal, []<span class="keyword">byte</span>(mikeStr), <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br><span class="line"></span><br><span class="line">stu := &amp;entity.Student&#123;Name: <span class="string">"Mike"</span>, Age: <span class="number">18</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// when</span></span><br><span class="line">res, err := stu.Print()</span><br><span class="line"></span><br><span class="line"><span class="comment">// then</span></span><br><span class="line">assert.Equal(t, <span class="string">"&#123;\"name\":\"Jasper\", \"age\":18&#125;"</span>, res)</span><br><span class="line">assert.Nil(t, err)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Demo示例-1"><a href="#Demo示例-1" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/1_gomock_2_gostub" target="_blank" rel="noopener">https://github.com/androidjp/go-mock-best-practice/tree/1_gomock_2_gostub</a></p>
<h1 id="goconvey更优化的断言"><a href="#goconvey更优化的断言" class="headerlink" title="goconvey更优化的断言"></a>goconvey更优化的断言</h1><h2 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h2><ul>
<li><p>更优雅地写测试用例</p>
</li>
<li><p>更好地可视化界面，实时更新当前所有测试情况和覆盖率</p>
</li>
</ul>
<h2 id="安装与配置-2"><a href="#安装与配置-2" class="headerlink" title="安装与配置"></a>安装与配置</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get -v -u github.com/smartystreets/goconvey</span><br></pre></td></tr></table></figure>

<h2 id="如何跑测试"><a href="#如何跑测试" class="headerlink" title="如何跑测试"></a>如何跑测试</h2><p>cd到测试文件所在目录，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go test -v</span><br></pre></td></tr></table></figure>

<p>或者，cd到项目根目录，全跑整个项目的测试：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> test ./... -v -cover</span><br></pre></td></tr></table></figure>

<p>或者执行以下命令，弹出web页面（默认：<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a>）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goconvey</span><br></pre></td></tr></table></figure>

<p>其中，<code>goconvey -help</code> 能出来相关的命令行选项说明，一般常用是这么写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goconvey -port 8112 -excludedDirs &quot;vendor,mock,proto,conf&quot;</span><br></pre></td></tr></table></figure>

<p>表示：web页面在 <a href="http://127.0.0.1:8112" target="_blank" rel="noopener">http://127.0.0.1:8112</a>，并且忽略当前上下文目录下的vendor目录、mock目录、proto目录。</p>
<p>图示：</p>
<p><img src="/images/20210323/2.png" alt=""></p>
<h2 id="格式规范"><a href="#格式规范" class="headerlink" title="格式规范"></a>格式规范</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestXxxService_XxxMethod</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  Convey(<span class="string">"should return 情况A"</span>, t, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Convey(<span class="string">"when 某逻辑 return `xxxx`"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// given</span></span><br><span class="line">            ..........各种准备逻辑（mock、stub、声明、初始化、造数据等）</span><br><span class="line">            <span class="comment">// when</span></span><br><span class="line">            res, err := xxxService.XxxMethod(....)</span><br><span class="line">            <span class="comment">// then</span></span><br><span class="line">            So(res, ShouldEqual, <span class="string">"情况A"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        Convey(<span class="string">"when 传入了参数 keyA=`valA`, keyB=`valB`"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Convey(<span class="string">"should return 情况B"</span>, t, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Convey(<span class="string">"when .................."</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">........</span><br><span class="line">Convey(&quot;should return `解析响应体失败：response is empty`&quot;, t, func() &#123;</span><br><span class="line">    Convey(&quot;when proxy response with statusCode 200 and empty body is returned&quot;, func() &#123;</span><br><span class="line">........</span><br></pre></td></tr></table></figure>

<h2 id="IDE-快速生成单元测试代码"><a href="#IDE-快速生成单元测试代码" class="headerlink" title="IDE 快速生成单元测试代码"></a>IDE 快速生成单元测试代码</h2><p><img src="/images/20210323/3.png" alt=""></p>
<p>以下的本人实践使用的模板：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Convey(<span class="string">"should $FIRST$"</span>, t, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Convey(<span class="string">"when $SECOND$"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//---------------------------------------</span></span><br><span class="line">        <span class="comment">// given</span></span><br><span class="line">        <span class="comment">//---------------------------------------</span></span><br><span class="line">        $END$</span><br><span class="line">        <span class="comment">//---------------------------------------</span></span><br><span class="line">        <span class="comment">// when</span></span><br><span class="line">        <span class="comment">//---------------------------------------</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//---------------------------------------</span></span><br><span class="line">        <span class="comment">// then</span></span><br><span class="line">        <span class="comment">//---------------------------------------</span></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>设置完毕后，写测试时，直接键入 <code>swg</code>然后点击 <code>tab</code>键，即可生成这段模板代码。</p>
<blockquote>
<p>注意：测试代码当然需要引入convey库：<code>import . &quot;github.com/smartystreets/goconvey/convey&quot;</code></p>
</blockquote>
<h2 id="Demo示例-2"><a href="#Demo示例-2" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/1_gomock_3_gostub_gocovey" target="_blank" rel="noopener">androidjp/go-mock-best-practice</a></p>
<h1 id="GoMonkey"><a href="#GoMonkey" class="headerlink" title="GoMonkey"></a>GoMonkey</h1><h2 id="需求-3"><a href="#需求-3" class="headerlink" title="需求"></a>需求</h2><ul>
<li><p>为一个函数打桩</p>
</li>
<li><p>为一个过程打桩</p>
</li>
<li><p>为一个方法打桩</p>
</li>
<li><p>特殊场景：桩中桩的一个案例</p>
</li>
</ul>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li><p>基本场景：为一个函数打桩</p>
</li>
<li><p>基本场景：为一个过程打桩</p>
</li>
<li><p>基本场景：为一个方法打桩</p>
</li>
<li><p>特殊场景：桩中桩的一个案例</p>
</li>
</ul>
<h2 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h2><ul>
<li><p>Monkey不是线程安全的，不要将Monkey用于并发的测试</p>
</li>
<li><p>对inline函数打桩无效（一般需要：通过命令行参数<code>-gcflags=-l</code>禁止inline）</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 像这种函数，很简单短小，在源码层面来看时有函数结构的，但是编译后却不具备函数的性质。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsEqual</span><span class="params">(a, b <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a == b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Monkey只能为首字母大写的方法/函数打桩（当然，这样其实更符合编码规范）。</p>
</li>
<li><p>API不够简洁优雅，同时不支持多次调用桩函数（方法）而呈现不同行为的复杂情况。</p>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -v bou.ke/monkey</span><br></pre></td></tr></table></figure>

<h2 id="运行单元测试"><a href="#运行单元测试" class="headerlink" title="运行单元测试"></a>运行单元测试</h2><p>方式一：命令行运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">test</span> -gcflags=-l -v</span><br></pre></td></tr></table></figure>

<p>方式二：IDE 运行：在 Go tool Arguments 栏加上这一个选项：<code>-gcflags=-l</code></p>
<p>注意：在运行测试时，可能出现运行报错的问题，</p>
<p>原因：由于它是在运行时替换了函数的指针，所以如果遇到一些简单的函数，例如 rand.Int63n 和 time.Now，编译器可能会直接将这种函数内联到调用实际发生的代码处并不会调用原有的方法，所以使用这种方式往往需要我们在测试时额外指定 -gcflags=-l 禁止编译器的内联优化。</p>
<p>这时，几种运行方式：</p>
<ol>
<li>命令行运行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">test</span> -gcflags=-l -v</span><br></pre></td></tr></table></figure></li>
<li>IDE运行，加上<code>-gcflags=-l</code><br> <img src="/images/20210323/4.png" alt=""></li>
</ol>
<h2 id="关键用法-2"><a href="#关键用法-2" class="headerlink" title="关键用法"></a>关键用法</h2><h3 id="1-函数打桩"><a href="#1-函数打桩" class="headerlink" title="1. 函数打桩"></a>1. 函数打桩</h3><ol>
<li><p>假设目前有这样一个函数 <code>Exec</code>：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Exec</span><span class="params">(cmd <span class="keyword">string</span>, args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//...........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们直接可以使用<code>monkey.Patch</code>将其打桩，不需要声明什么变量：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打桩</span></span><br><span class="line">guard := Patch(service.Exec, <span class="function"><span class="keyword">func</span><span class="params">(cmd <span class="keyword">string</span>, args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"sss"</span>, <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">defer</span> guard.Unpatch()</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">output, err := service.Exec(<span class="string">"cmd01"</span>, <span class="string">"--conf"</span>, <span class="string">"conf/app_test.yaml"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="2-过程打桩"><a href="#2-过程打桩" class="headerlink" title="2. 过程打桩"></a>2. 过程打桩</h3><p>和函数一样，相较于<code>gostub</code>好的一点，就是不需要声明变量去指向这个函数，从而减少业务代码的修改。</p>
<ol>
<li>假设有这样一个过程： <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InternalDoSth</span><span class="params">(mData <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    mData[<span class="string">"keyA"</span>] = <span class="string">"valA"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>一样方式进行打桩 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">patchGuard := Patch(service.InternalDoSth, <span class="function"><span class="keyword">func</span><span class="params">(mData <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    mData[<span class="string">"keyA"</span>] = <span class="string">"valB"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">defer</span> patchGuard.Unpatch()</span><br><span class="line"></span><br><span class="line">..............</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="3-方法打桩"><a href="#3-方法打桩" class="headerlink" title="3. 方法打桩"></a>3. 方法打桩</h3><p>注意：只能打Public方法的桩，也就是首字母大写的方法</p>
<ol>
<li><p>假设有这样一个类以及它的方法定义：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Etcd <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成员方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Etcd)</span> <span class="title">Get</span><span class="params">(id <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    names := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">switch</span> id &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        names = <span class="built_in">append</span>(names, <span class="string">"A"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        names = <span class="built_in">append</span>(names, <span class="string">"B"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> names</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Etcd)</span> <span class="title">Save</span><span class="params">(vals []<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"存储DB成功"</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Etcd)</span> <span class="title">GetAndSave</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    vals := e.Get(id)</span><br><span class="line">    <span class="keyword">if</span> vals[<span class="number">0</span>] == <span class="string">"A"</span> &#123;</span><br><span class="line">        vals[<span class="number">0</span>] = <span class="string">"C"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e.Save(vals)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过<code>PatchInstanceMethod</code>即可打桩，然后直接调用:</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打桩</span></span><br><span class="line"><span class="keyword">var</span> e = &amp;service.Etcd&#123;&#125;</span><br><span class="line">guard := PatchInstanceMethod(reflect.TypeOf(e), <span class="string">"Get"</span>, <span class="function"><span class="keyword">func</span><span class="params">(e *service.Etcd, id <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> []<span class="keyword">string</span>&#123;<span class="string">"Jasper"</span>&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">defer</span> guard.Unpatch()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">res := e.Get(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>当我想要一个测试用例里打多个成员方法的桩，这样即可：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> e = &amp;service.Etcd&#123;&#125;</span><br><span class="line"><span class="comment">// stub Get</span></span><br><span class="line">theVals := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>)</span><br><span class="line">theVals = <span class="built_in">append</span>(theVals, <span class="string">"A"</span>)</span><br><span class="line">PatchInstanceMethod(reflect.TypeOf(e), <span class="string">"Get"</span>, <span class="function"><span class="keyword">func</span><span class="params">(e *service.Etcd, id <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> theVals</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// stub Save</span></span><br><span class="line">PatchInstanceMethod(reflect.TypeOf(e), <span class="string">"Save"</span>, <span class="function"><span class="keyword">func</span><span class="params">(e *service.Etcd, vals []<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>, errors.New(<span class="string">"occurs error"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一键删除所有补丁</span></span><br><span class="line"><span class="keyword">defer</span> UnpatchAll()</span><br><span class="line"></span><br><span class="line">.............</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="4-配合gomock（桩中桩）"><a href="#4-配合gomock（桩中桩）" class="headerlink" title="4. 配合gomock（桩中桩）"></a>4. 配合gomock（桩中桩）</h3><p>当我需要mock一个接口，并且，重新定义这个mock对象的某个方法时，使用。</p>
<p>详情看demo例子<code>repo_test.go</code></p>
<h2 id="Demo示例-3"><a href="#Demo示例-3" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/3_monkey" target="_blank" rel="noopener">androidjp/go-mock-best-practice</a></p>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><p>由于使用GoMonkey Patch后导致GoConvey命令不能正常运行测试用例</p>
<p>解决方案：<br><a href="https://blog.csdn.net/scun_cg/article/details/88395041" target="_blank" rel="noopener">https://blog.csdn.net/scun_cg/article/details/88395041</a></p>
<h1 id="原生http服务接口测试"><a href="#原生http服务接口测试" class="headerlink" title="原生http服务接口测试"></a>原生http服务接口测试</h1><h2 id="需求-4"><a href="#需求-4" class="headerlink" title="需求"></a>需求</h2><ul>
<li>原生<code>net/http</code>写的web服务，http接口需要单元测试。</li>
</ul>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>假设我们不用任何web框架（Gin、Beego、Echo等），使用原生的golang <code>net/http</code> 库编写一个RESTful接口服务，这样写：</p>
<ol>
<li><p>定义controller</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  instanceDemoController *DemoController</span><br><span class="line">  initDemoControllerOnce sync.Once</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DemoController <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetDemoController</span><span class="params">()</span> *<span class="title">DemoController</span></span> &#123;</span><br><span class="line">  initDemoControllerOnce.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    instanceDemoController = &amp;DemoController&#123;&#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> instanceDemoController</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DemoController)</span> <span class="title">GetMessage</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  r.ParseForm()       <span class="comment">// 解析参数，默认是不会解析的</span></span><br><span class="line">  fmt.Println(r.Form) <span class="comment">// 这些信息是输出到服务器端的打印信息</span></span><br><span class="line">  fmt.Println(<span class="string">"path"</span>, r.URL.Path)</span><br><span class="line">  fmt.Println(<span class="string">"scheme"</span>, r.URL.Scheme)</span><br><span class="line">  fmt.Println(r.Form[<span class="string">"url_long"</span>])</span><br><span class="line">  <span class="keyword">for</span> k, v := <span class="keyword">range</span> r.Form &#123;</span><br><span class="line">    fmt.Println(<span class="string">"key:"</span>, k)</span><br><span class="line">    fmt.Println(<span class="string">"val:"</span>, strings.Join(v, <span class="string">""</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  fmt.Fprintf(w, <span class="string">"Hello Mike!"</span>) <span class="comment">// 这个写入到 w 的是输出到客户端的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>main方式直接使用http包的<code>HandleFunc</code>和<code>ListenAndServe</code>方法即可完成监听并启动服务：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 设置访问的路由</span></span><br><span class="line">  http.HandleFunc(<span class="string">"/message"</span>, controller.GetDemoController().GetMessage)</span><br><span class="line">  <span class="comment">// 设置监听的端口</span></span><br><span class="line">  fmt.Println(<span class="string">"Start listening 9090, 尝试请求：http://localhost:9090/message?keyA=valA&amp;url_long=123456"</span>)</span><br><span class="line">  <span class="keyword">if</span> err := http.ListenAndServe(<span class="string">":9090"</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(<span class="string">"ListenAdnServe: "</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 那，如果我要单元测试测这个接口怎么办？原生的<code>net/http/httptest</code> 就能帮到你：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// given</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">demoCtrl := &amp;controller.DemoController&#123;&#125;</span><br><span class="line">ts := httptest.NewServer(http.HandlerFunc(demoCtrl.GetMessage))</span><br><span class="line"><span class="keyword">defer</span> ts.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// when</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">resp, err := http.Get(ts.URL)</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">bodyBytes, err := ioutil.ReadAll(resp.Body)</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// then</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">assert.Nil(t, err)</span><br><span class="line">assert.Equal(t, <span class="string">"Hello Mike!"</span>, <span class="keyword">string</span>(bodyBytes))</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Demo示例-4"><a href="#Demo示例-4" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/2_web_2_raw_http_httptest" target="_blank" rel="noopener">androidjp/go-mock-best-practice</a></p>
<h1 id="Gin接口测试"><a href="#Gin接口测试" class="headerlink" title="Gin接口测试"></a>Gin接口测试</h1><p>gin官方文档：<a href="https://github.com/gin-gonic/gin#quick-start" target="_blank" rel="noopener">https://github.com/gin-gonic/gin#quick-start</a></p>
<h2 id="需求-5"><a href="#需求-5" class="headerlink" title="需求"></a>需求</h2><ul>
<li>测试基于Gin框架写的API接口。</li>
</ul>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>我们可以使用原生的httptest来测试接口，当然也可以使用其他的库，如：<a href="https://apitest.dev/" target="_blank" rel="noopener">apitest</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gin</span></span><br><span class="line"><span class="keyword">go</span> get -v -u github.com/gin-gonic/gin</span><br><span class="line"><span class="comment">// testify 断言库</span></span><br><span class="line"><span class="keyword">go</span> get -v -u github.com/stretchr/testify</span><br></pre></td></tr></table></figure>

<h2 id="原生测试写法"><a href="#原生测试写法" class="headerlink" title="原生测试写法"></a>原生测试写法</h2><ol>
<li><p>首先，我们DemoController代码逻辑基本没变，只是需要采用<code>*gin.Context</code> ，启动函数只是变得更简洁而已：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 设置访问的路由</span></span><br><span class="line">  r := gin.Default()</span><br><span class="line">  r.GET(<span class="string">"/message"</span>, controller.GetDemoController().GetMessage)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置监听的端口</span></span><br><span class="line">  fmt.Println(<span class="string">"Start listening 9090, 尝试请求：http://localhost:9090/message?keyA=valA&amp;url_long=123456"</span>)</span><br><span class="line">  <span class="keyword">if</span> err := r.Run(<span class="string">":9090"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(<span class="string">"ListenAdnServe: "</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>那么，测试用例写法，也只是前期准备gin测试环境的逻辑有所不同罢了：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// given</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">gin.SetMode(gin.TestMode)</span><br><span class="line">router := gin.New()</span><br><span class="line">demoCtrl := &amp;controller.DemoController&#123;&#125;</span><br><span class="line"><span class="comment">//待测试的接口</span></span><br><span class="line">router.GET(<span class="string">"/message"</span>, demoCtrl.GetMessage)</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// when</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// 构建返回值</span></span><br><span class="line">w := httptest.NewRecorder()</span><br><span class="line"><span class="comment">// 构建请求</span></span><br><span class="line">req, _ := http.NewRequest(<span class="string">"GET"</span>, <span class="string">"/message?keyA=valA&amp;url_long=123456"</span>, <span class="literal">nil</span>)</span><br><span class="line"><span class="comment">//调用请求接口</span></span><br><span class="line">router.ServeHTTP(w, req)</span><br><span class="line"></span><br><span class="line">resp := w.Result()</span><br><span class="line">body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// then</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">assert.Nil(t, err)</span><br><span class="line">assert.Equal(t, <span class="string">"Hello Mike!"</span>, <span class="keyword">string</span>(body))</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Demo示例-5"><a href="#Demo示例-5" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/2_web_3_gin_httptest" target="_blank" rel="noopener">androidjp/go-mock-best-practice</a></p>
<h1 id="apitest"><a href="#apitest" class="headerlink" title="apitest"></a>apitest</h1><h2 id="需求-6"><a href="#需求-6" class="headerlink" title="需求"></a>需求</h2><ul>
<li>对golang原生http或者Gin等框架下的RESTFul API接口进行更简洁的测试</li>
</ul>
<h2 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h2><p>官网：<a href="https://apitest.dev/" target="_blank" rel="noopener">https://apitest.dev/</a></p>
<p>github地址：<a href="https://github.com/steinfletcher/apitest" target="_blank" rel="noopener">https://github.com/steinfletcher/apitest</a></p>
<p><code>go get -u github.com/steinfletcher/apitest</code></p>
<h2 id="用apitest测试Gin接口"><a href="#用apitest测试Gin接口" class="headerlink" title="用apitest测试Gin接口"></a>用apitest测试Gin接口</h2><p>各种apitest详细用法可以参考官方文档，这里只说说也前面使用原生httptest的最大区别：更简洁了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// given</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">gin.SetMode(gin.TestMode)</span><br><span class="line">router := gin.New()</span><br><span class="line">demoCtrl := &amp;controller.DemoController&#123;&#125;</span><br><span class="line"><span class="comment">//待测试的接口</span></span><br><span class="line">router.GET(<span class="string">"/message"</span>, demoCtrl.GetMessage)</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line"><span class="comment">// when then</span></span><br><span class="line"><span class="comment">//---------------------------------------</span></span><br><span class="line">apitest.New().</span><br><span class="line">  Handler(router).</span><br><span class="line">  Getf(<span class="string">"/message?keyA=%s&amp;url_long=1%s"</span>, <span class="string">"valA"</span>, <span class="string">"123456"</span>).</span><br><span class="line">  Header(<span class="string">"Client-Type"</span>, <span class="string">"pc"</span>).</span><br><span class="line">  Cookie(<span class="string">"sid"</span>, <span class="string">"id001"</span>).</span><br><span class="line">  JSON(<span class="literal">nil</span>).</span><br><span class="line">  Expect(t).</span><br><span class="line">  Status(http.StatusOK).</span><br><span class="line">  Assert(jsonPath.Equal(<span class="string">`$.code`</span>, <span class="keyword">float64</span>(<span class="number">2000</span>))).</span><br><span class="line">  Assert(jsonPath.Equal(<span class="string">`$.msg`</span>, <span class="string">"Hello Mike!"</span>)).</span><br><span class="line">  Body(<span class="string">`&#123;"code":2000,"msg":"Hello Mike!"&#125;`</span>).</span><br><span class="line">  End()</span><br></pre></td></tr></table></figure>

<h2 id="Demo示例-6"><a href="#Demo示例-6" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><a href="https://github.com/androidjp/go-mock-best-practice/tree/2_web_4_gin_apitest" target="_blank" rel="noopener">androidjp/go-mock-best-practice</a></p>
<h1 id="Beego-接口测试"><a href="#Beego-接口测试" class="headerlink" title="Beego 接口测试"></a>Beego 接口测试</h1><p>参考文章：<a href="https://blog.csdn.net/qq_38959696/article/details/106567212" target="_blank" rel="noopener">https://blog.csdn.net/qq_38959696/article/details/106567212</a></p>
<h1 id="SqlMock使用"><a href="#SqlMock使用" class="headerlink" title="SqlMock使用"></a>SqlMock使用</h1><p>github：<a href="https://github.com/DATA-DOG/go-sqlmock" target="_blank" rel="noopener">https://github.com/DATA-DOG/go-sqlmock</a></p>
<h2 id="需求-7"><a href="#需求-7" class="headerlink" title="需求"></a>需求</h2><ul>
<li>测试自己写的sql脚本等与DB存取息息相关的细节逻辑有没有问题</li>
</ul>
<h2 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get -v -u github.com/DATA-DOG/<span class="keyword">go</span>-sqlmock</span><br></pre></td></tr></table></figure>

<h2 id="关键用法-3"><a href="#关键用法-3" class="headerlink" title="关键用法"></a>关键用法</h2><h3 id="情况一：直接将db对象作为入参"><a href="#情况一：直接将db对象作为入参" class="headerlink" title="情况一：直接将db对象作为入参"></a>情况一：直接将db对象作为入参</h3><p>假设有这样的一个函数，直接传入的是<code>*sql.DB</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DemoService)</span> <span class="title">AddStudentDirectly</span><span class="params">(db *sql.DB, name <span class="keyword">string</span>)</span> <span class="params">(stu *entities.Student, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 启动事务</span></span><br><span class="line">  tx, err := db.Begin()</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> err &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">      err = tx.Commit()</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      tx.Rollback()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 先新增一个学生信息</span></span><br><span class="line">  result, err := db.Exec(<span class="string">"insert into students(name) values(?)"</span>, name)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  id, err := result.LastInsertId()</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2. 然后，给教室1 添加这个学生</span></span><br><span class="line">  <span class="keyword">if</span> _, err = db.Exec(<span class="string">"insert into classroom_1(stu_id) values(?)"</span>, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  stu = &amp;entities.Student&#123;ID: id, Name: name&#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上函数做的事情：开事务、插入students表、将得到的id，插入另一长classroom_1表，最终提交事务。</p>
<p>这种情况，只需要想办法mock掉这个<code>db *sql.DB</code>对象即可：</p>
<ol>
<li><p>sqlmock.New()得到mock掉了的db对象，以及mock记录器对象；</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db, mock, err := sqlmock.New()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  t.Fatalf(<span class="string">"an error '%s' was not expected when opening a stub database connection"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> db.Close()</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置即将要发生什么DB操作，并且设置将返回什么值：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) 首先是会 开启事务</span></span><br><span class="line">mock.ExpectBegin()</span><br><span class="line"><span class="comment">// 2) 然后是插入students表，最终返回id=1, 影响行数=1</span></span><br><span class="line">mock.ExpectExec(regexp.QuoteMeta(<span class="string">`insert into students(name) values(?)`</span>)).WithArgs(<span class="string">"mike"</span>).WillReturnResult(sqlmock.NewResult(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// 3) 插入classroom_1表</span></span><br><span class="line">mock.ExpectExec(regexp.QuoteMeta(<span class="string">"insert into classroom_1(stu_id) values(?)"</span>)).WithArgs(<span class="number">1</span>).WillReturnResult(sqlmock.NewResult(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// 4) 提交事务</span></span><br><span class="line">mock.ExpectCommit()</span><br></pre></td></tr></table></figure>
</li>
<li><p>将mock了的db对象，作为入参：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...........</span><br><span class="line">stu, err := svr.AddStudentDirectly(db, <span class="string">"mike"</span>)</span><br><span class="line">...........</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="情况二：有自己的repository层对象，去封装db的相关操作"><a href="#情况二：有自己的repository层对象，去封装db的相关操作" class="headerlink" title="情况二：有自己的repository层对象，去封装db的相关操作"></a>情况二：有自己的repository层对象，去封装db的相关操作</h3><p>一般我们写项目代码，职责单一，分层明确，很多时候，会是另一种写法：repository层的某个XxxRepository类拥有DB连接对象，然后，有一系列对应的DB相关操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MySQLRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">  db *sql.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMySQLRepository</span><span class="params">()</span> *<span class="title">MySQLRepository</span></span> &#123;</span><br><span class="line">  db, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:root@tcp(192.168.200.128:3307)/test?charset=utf8mb4"</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">  db.SetConnMaxLifetime(time.Minute * <span class="number">2</span>)</span><br><span class="line">  db.SetMaxOpenConns(<span class="number">10</span>)</span><br><span class="line">  db.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;MySQLRepository&#123;</span><br><span class="line">    db: db,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MySQLRepository)</span> <span class="title">CreateStudent</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(stu *entities.Student, err error)</span></span> &#123;</span><br><span class="line">    ..........................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，如果想要更好地达到mock的目的，那么，需要配置gostub框架：</p>
<ol>
<li><p>首先，源码需要稍微做一些调整，加上adapter适配一下<code>sql.Open</code>为<code>adapter.Open</code>：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> adapter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"database/sql"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Open = sql.Open</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，同样是通过sqlmock定义mock的db对象：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db, mock, err := sqlmock.New()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  t.Fatalf(<span class="string">"an error '%s' was not expected when opening a stub database connection"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">mock.ExpectBegin()</span><br><span class="line">mock.ExpectExec(regexp.QuoteMeta(<span class="string">`insert into students(name) values(?)`</span>)).WithArgs(<span class="string">"mike"</span>).WillReturnResult(sqlmock.NewResult(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">mock.ExpectExec(regexp.QuoteMeta(<span class="string">"insert into classroom_1(stu_id) values(?)"</span>)).WithArgs(<span class="number">1</span>).WillReturnResult(sqlmock.NewResult(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">mock.ExpectCommit()</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，gostub让adapter.Open打桩，让其返回我们mock的db对象：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stubs := gostub.StubFunc(&amp;adapter.Open, db, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">defer</span> stubs.Reset()</span><br></pre></td></tr></table></figure>
</li>
<li><p>最终实际跑逻辑进行测试：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlRepository := repository.NewMySQLRepository()</span><br><span class="line">student, err := sqlRepository.CreateStudent(<span class="string">"mike"</span>)</span><br></pre></td></tr></table></figure>
<p> 当然，对于不同的ORM框架，有一些不同的封装逻辑，获取到的db操作对象也可能不是<code>*sql.DB</code> 类型，这里详细可以看Demo示例，这里目前只实践了MySQL gorm和xorm两个ORM框架的mock实践。</p>
</li>
</ol>
<h2 id="Demo示例-7"><a href="#Demo示例-7" class="headerlink" title="Demo示例"></a>Demo示例</h2><ul>
<li><p>MySQL 原生 sql-driver 的mock：<a href="https://github.com/androidjp/go-mock-best-practice/tree/4_db_1_sqlmock_sqldriver" target="_blank" rel="noopener">https://github.com/androidjp/go-mock-best-practice/tree/4_db_1_sqlmock_sqldriver</a></p>
</li>
<li><p>MySQL gorm ORM框架mock：<a href="https://github.com/androidjp/go-mock-best-practice/tree/4_db_2_sqlmock_gorm" target="_blank" rel="noopener">https://github.com/androidjp/go-mock-best-practice/tree/4_db_2_sqlmock_gorm</a></p>
</li>
<li><p>MySQL xorm ORM框架mock：<a href="https://github.com/androidjp/go-mock-best-practice/tree/4_db_3_sqlmock_xorm" target="_blank" rel="noopener">https://github.com/androidjp/go-mock-best-practice/tree/4_db_3_sqlmock_xorm</a></p>
</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="一、Gin的-gin-Context-怎么mock？"><a href="#一、Gin的-gin-Context-怎么mock？" class="headerlink" title="一、Gin的*gin.Context 怎么mock？"></a>一、Gin的<code>*gin.Context</code> 怎么mock？</h2><ol>
<li><p>首先，在测试文件中定义一个MockResponseWriter结构体：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MockResponseWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MockResponseWriter)</span> <span class="title">Header</span><span class="params">()</span> <span class="title">http</span>.<span class="title">Header</span></span> &#123;</span><br><span class="line">  h := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</span><br><span class="line">  h[<span class="string">"Client-Type"</span>] = []<span class="keyword">string</span>&#123;<span class="string">"wps-pc"</span>&#125;</span><br><span class="line">  <span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MockResponseWriter)</span> <span class="title">Write</span><span class="params">([]<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MockResponseWriter)</span> <span class="title">WriteHeader</span><span class="params">(statusCode <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>利用gin.CreateTestContext，来构造整个gin.Context：</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mockGinContext, _ := gin.CreateTestContext(&amp;MockResponseWriter&#123;&#125;)</span><br><span class="line">mockGinContext.Request = &amp;http.Request&#123;&#125;</span><br><span class="line"><span class="comment">// mock request header</span></span><br><span class="line">mockGinContext.Request.Header = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</span><br><span class="line">mockGinContext.Request.Header[<span class="string">"Client-Type"</span>] = []<span class="keyword">string</span>&#123;<span class="string">"wps-pc"</span>&#125;</span><br><span class="line">mockGinContext.Request.Header[<span class="string">"Client-Chan"</span>] = []<span class="keyword">string</span>&#123;<span class="string">"00050.88888888"</span>&#125;</span><br><span class="line">mockGinContext.Request.Header[<span class="string">"Client-Ver"</span>] = []<span class="keyword">string</span>&#123;<span class="string">"1.0.1"</span>&#125;</span><br><span class="line">mockGinContext.Request.Header[<span class="string">"X-Forwarded-Host"</span>] = []<span class="keyword">string</span>&#123;<span class="string">"test.com"</span>&#125;</span><br><span class="line">mockGinContext.Request.URL = &amp;url.URL&#123;Path: <span class="string">"/api/v2/proofread"</span>&#125;</span><br><span class="line">mockGinContext.Set(<span class="string">"uid"</span>, <span class="string">"123123123"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// mock request body</span></span><br><span class="line">mockGinContext.Request.Body = ioutil.NopCloser(bytes.NewReader([]<span class="keyword">byte</span>(<span class="string">"&#123;\"key\":\"val\",\"userid\":123123&#125;"</span>)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>ok，这个<code>mockGinContext</code>可以被我们拿来作为参数使用了。</p>
</li>
</ol>
<h2 id="二、POST-data-using-the-Content-Type-multipart-form-data"><a href="#二、POST-data-using-the-Content-Type-multipart-form-data" class="headerlink" title="二、POST data using the Content-Type multipart/form-data"></a>二、<a href="https://stackoverflow.com/questions/20205796/post-data-using-the-content-type-multipart-form-data" target="_blank" rel="noopener">POST data using the Content-Type multipart/form-data</a></h2><p>In short, you’ll need to use the mime/multipart package to build the form.</p>
<p>sample代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"bytes"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">    <span class="string">"mime/multipart"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"net/http/httptest"</span></span><br><span class="line">    <span class="string">"net/http/httputil"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> client *http.Client</span><br><span class="line">    <span class="keyword">var</span> remoteURL <span class="keyword">string</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//setup a mocked http client.</span></span><br><span class="line">        ts := httptest.NewTLSServer(http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">            b, err := httputil.DumpRequest(r, <span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(err)</span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Printf(<span class="string">"%s"</span>, b)</span><br><span class="line">        &#125;))</span><br><span class="line">        <span class="keyword">defer</span> ts.Close()</span><br><span class="line">        client = ts.Client()</span><br><span class="line">        remoteURL = ts.URL</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//prepare the reader instances to encode</span></span><br><span class="line">    values := <span class="keyword">map</span>[<span class="keyword">string</span>]io.Reader&#123;</span><br><span class="line">        <span class="string">"file"</span>:  mustOpen(<span class="string">"main.go"</span>), <span class="comment">// lets assume its this file</span></span><br><span class="line">        <span class="string">"other"</span>: strings.NewReader(<span class="string">"hello world!"</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    err := Upload(client, remoteURL, values)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Upload</span><span class="params">(client *http.Client, url <span class="keyword">string</span>, values <span class="keyword">map</span>[<span class="keyword">string</span>]io.Reader)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Prepare a form that you will submit to that URL.</span></span><br><span class="line">    <span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">    w := multipart.NewWriter(&amp;b)</span><br><span class="line">    <span class="keyword">for</span> key, r := <span class="keyword">range</span> values &#123;</span><br><span class="line">        <span class="keyword">var</span> fw io.Writer</span><br><span class="line">        <span class="keyword">if</span> x, ok := r.(io.Closer); ok &#123;</span><br><span class="line">            <span class="keyword">defer</span> x.Close()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Add an image file</span></span><br><span class="line">        <span class="keyword">if</span> x, ok := r.(*os.File); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> fw, err = w.CreateFormFile(key, x.Name()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Add other fields</span></span><br><span class="line">            <span class="keyword">if</span> fw, err = w.CreateFormField(key); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> _, err = io.Copy(fw, r); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Don't forget to close the multipart writer.</span></span><br><span class="line">    <span class="comment">// If you don't close it, your request will be missing the terminating boundary.</span></span><br><span class="line">    w.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now that you have a form, you can submit it to your handler.</span></span><br><span class="line">    req, err := http.NewRequest(<span class="string">"POST"</span>, url, &amp;b)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Don't forget to set the content type, this will contain the boundary.</span></span><br><span class="line">    req.Header.Set(<span class="string">"Content-Type"</span>, w.FormDataContentType())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Submit the request</span></span><br><span class="line">    res, err := client.Do(req)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the response</span></span><br><span class="line">    <span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">        err = fmt.Errorf(<span class="string">"bad status: %s"</span>, res.Status)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mustOpen</span><span class="params">(f <span class="keyword">string</span>)</span> *<span class="title">os</span>.<span class="title">File</span></span> &#123;</span><br><span class="line">    r, err := os.Open(f)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode.png" alt="Jasper Wu wechat" style="width: 200px; max-width: 100%;">
  <div>喜欢的朋友可以关注 "JP技术栈" 微信公众号，每周更新笔者最新分享技术文章~</div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
              <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="tag"># 单元测试</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/Go%E6%B5%8B%E8%AF%95%E7%B3%BB%E5%88%97%E4%B8%80%EF%BC%9A%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="next" title="Go测试系列一：单元测试">
                  <i class="fa fa-chevron-left"></i> Go测试系列一：单元测试
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#gomock-mockgen"><span class="nav-number">1.</span> <span class="nav-text">gomock + mockgen</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求"><span class="nav-number">1.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装与配置"><span class="nav-number">1.2.</span> <span class="nav-text">安装与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档"><span class="nav-number">1.3.</span> <span class="nav-text">文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mockgen使用"><span class="nav-number">1.4.</span> <span class="nav-text">mockgen使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关键用法"><span class="nav-number">1.5.</span> <span class="nav-text">关键用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-接口打桩步骤"><span class="nav-number">1.5.1.</span> <span class="nav-text">1. 接口打桩步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-接口打桩定义前N次返回值"><span class="nav-number">1.5.2.</span> <span class="nav-text">2. 接口打桩定义前N次返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-断言接口调用顺序"><span class="nav-number">1.5.3.</span> <span class="nav-text">3. 断言接口调用顺序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例"><span class="nav-number">1.6.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#gostub打桩"><span class="nav-number">2.</span> <span class="nav-text">gostub打桩</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-1"><span class="nav-number">2.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装与配置-1"><span class="nav-number">2.2.</span> <span class="nav-text">安装与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关键用法-1"><span class="nav-number">2.3.</span> <span class="nav-text">关键用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-全局变量打桩"><span class="nav-number">2.3.1.</span> <span class="nav-text">1. 全局变量打桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-函数打桩"><span class="nav-number">2.3.2.</span> <span class="nav-text">2. 函数打桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-过程打桩"><span class="nav-number">2.3.3.</span> <span class="nav-text">3. 过程打桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-第三方库打桩"><span class="nav-number">2.3.4.</span> <span class="nav-text">4. 第三方库打桩</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-1"><span class="nav-number">2.4.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#goconvey更优化的断言"><span class="nav-number">3.</span> <span class="nav-text">goconvey更优化的断言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-2"><span class="nav-number">3.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装与配置-2"><span class="nav-number">3.2.</span> <span class="nav-text">安装与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何跑测试"><span class="nav-number">3.3.</span> <span class="nav-text">如何跑测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#格式规范"><span class="nav-number">3.4.</span> <span class="nav-text">格式规范</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDE-快速生成单元测试代码"><span class="nav-number">3.5.</span> <span class="nav-text">IDE 快速生成单元测试代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-2"><span class="nav-number">3.6.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GoMonkey"><span class="nav-number">4.</span> <span class="nav-text">GoMonkey</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-3"><span class="nav-number">4.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用场景"><span class="nav-number">4.2.</span> <span class="nav-text">使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#局限"><span class="nav-number">4.3.</span> <span class="nav-text">局限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">4.4.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行单元测试"><span class="nav-number">4.5.</span> <span class="nav-text">运行单元测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关键用法-2"><span class="nav-number">4.6.</span> <span class="nav-text">关键用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-函数打桩"><span class="nav-number">4.6.1.</span> <span class="nav-text">1. 函数打桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-过程打桩"><span class="nav-number">4.6.2.</span> <span class="nav-text">2. 过程打桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-方法打桩"><span class="nav-number">4.6.3.</span> <span class="nav-text">3. 方法打桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-配合gomock（桩中桩）"><span class="nav-number">4.6.4.</span> <span class="nav-text">4. 配合gomock（桩中桩）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-3"><span class="nav-number">4.7.</span> <span class="nav-text">Demo示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#坑"><span class="nav-number">4.8.</span> <span class="nav-text">坑</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#原生http服务接口测试"><span class="nav-number">5.</span> <span class="nav-text">原生http服务接口测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-4"><span class="nav-number">5.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#例子"><span class="nav-number">5.2.</span> <span class="nav-text">例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-4"><span class="nav-number">5.3.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Gin接口测试"><span class="nav-number">6.</span> <span class="nav-text">Gin接口测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-5"><span class="nav-number">6.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-1"><span class="nav-number">6.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原生测试写法"><span class="nav-number">6.3.</span> <span class="nav-text">原生测试写法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-5"><span class="nav-number">6.4.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#apitest"><span class="nav-number">7.</span> <span class="nav-text">apitest</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-6"><span class="nav-number">7.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-2"><span class="nav-number">7.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用apitest测试Gin接口"><span class="nav-number">7.3.</span> <span class="nav-text">用apitest测试Gin接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-6"><span class="nav-number">7.4.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Beego-接口测试"><span class="nav-number">8.</span> <span class="nav-text">Beego 接口测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SqlMock使用"><span class="nav-number">9.</span> <span class="nav-text">SqlMock使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-7"><span class="nav-number">9.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-3"><span class="nav-number">9.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关键用法-3"><span class="nav-number">9.3.</span> <span class="nav-text">关键用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#情况一：直接将db对象作为入参"><span class="nav-number">9.3.1.</span> <span class="nav-text">情况一：直接将db对象作为入参</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#情况二：有自己的repository层对象，去封装db的相关操作"><span class="nav-number">9.3.2.</span> <span class="nav-text">情况二：有自己的repository层对象，去封装db的相关操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo示例-7"><span class="nav-number">9.4.</span> <span class="nav-text">Demo示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他"><span class="nav-number">10.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Gin的-gin-Context-怎么mock？"><span class="nav-number">10.1.</span> <span class="nav-text">一、Gin的*gin.Context 怎么mock？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、POST-data-using-the-Content-Type-multipart-form-data"><span class="nav-number">10.2.</span> <span class="nav-text">二、POST data using the Content-Type multipart/form-data</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Jasper Wu"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Jasper Wu</p>
  <div class="site-description" itemprop="description">醒目点、自觉点、速度点，努力奋斗下去，走好自己的路！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/androidjp" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;androidjp" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1049578026@qq.com" title="E-Mail &amp;rarr; mailto:1049578026@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jasper Wu</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  






  <script src="/js/local-search.js"></script>










<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'default',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

  

  

</body>
</html>
