---
title: Dubbo架构图解分析
date: 2019-10-28 21:35:03
tags:
- Dubbo
categories:
- Dubbo
---

# 分析官方架构图
![](/images/dubbo/官方架构图_1.png)

<!--more-->

角色说明：

节点 | 角色说明
--- | ---
`Provider`| 服务提供方（暴露服务）
`Consumer`| 服务消费者（调用远程服务）
`Registry`|注册中心（服务注册与发现）
`Monitor`| 监控中心（统计服务调用次数和调用时间）
`Container`|服务运行容器

步骤：
* 0 -- 首先，服务容器负责启动，加载，运行服务提供者。
* 1 -- 服务提供者在启动时，向注册中心注册自己提供的服务。
* 2 -- 服务消费者在启动时，向注册中心订阅自己所需的服务。
* 3 -- 注册中心返回 **服务提供者地址列表** 给消费者，如果有变更，注册中心将基于 **长连接** 推送变更数据给消费者。
* 4 -- 服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。
* 5 -- 服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。

# Dubbo的特点
## 连通性
* 注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小
* 监控中心负责统计各服务调用次数，调用时间等，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示
* 服务提供者向注册中心注册其提供的服务，并汇报调用时间到监控中心，此时间不包含网络开销
* 服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包含网络开销
* 注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外
* 注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者
* 注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表
* 注册中心和监控中心都是可选的，服务消费者可以直连服务提供者

> 疑问： 如果服务提供者宕机了，而注册中心又没来得及通知消费者，此时如果消费者正好在调用 此服务提供者，那么，会发生什么？
>
> 答： 服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复。

## 健壮性
* 监控中心宕掉不影响使用，只是丢失部分采样数据
* 数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务
* 注册中心对等集群，任意一台宕掉后，将自动切换到另一台
* 注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯
* 服务提供者无状态，任意一台宕掉后，不影响使用
* 服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复

## 伸缩性
* 注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心
* 服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者

## 升级性
当服务集群规模进一步扩大，带动IT治理结构进一步升级，需要实现动态部署，进行流动计算，现有分布式服务架构不会带来阻力。下图是未来可能的一种架构：

![](/images/dubbo-architecture-future.jpg)

节点角色说明：

节点|角色说明
---|---
`Deployer`|自动部署服务的本地代理
`Repository`|仓库（用于存储服务应用发布包）
`Scheduler`|调度中心（基于访问压力自动增减服务提供者）
`Admin`|统一管理控制台
`Registry`| 注册中心（服务注册与发现）
`Monitor`| 监控中心（统计服务的调用次数和调用时间）

整个流程解析：
1. 部署开始，在管理平台上trigger 上传一个版本到仓库
2. 然后，启动调度器 并将让其开始调度
3. 调度器执行其调度工作：当Deployer 执行 deploy 方法
4. 从仓库中拉取服务提供者的新版本
5. Deployer作为本地代理，被调度器启动，会启动 容器
6. 容器被启动后，其内部已下载的 服务提供者 则会跟随启动并初始化，注册自己到注册中心上
7. Admin 路由到 注册中心
8. 消费者订阅 注册中心
9. 消费者收到来自注册中心的更新提醒：“服务提供者有新版本已上线，可供使用了，其ip地址是：xxxx”
10. 好，此时消费者就会根据注册中心的新名册，去调用新deploy的服务提供者。
11. 同时，消费者将请求历史一一上报给监控中心Monitor
12. 监控中心再发送报告给调度器，从而让调度器实时知道当前的负荷高低
13. 管理控制台可以实时显示监控中心的统计数据

# 参考文章
* http://dubbo.apache.org/zh-cn/docs/user/preface/architecture.html